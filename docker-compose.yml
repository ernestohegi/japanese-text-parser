services:
  yochimu:
    image: ernestohegi/yochimu:latest
    restart: unless-stopped
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3

    environment:
      - MY_HOST=${MY_HOST}

    labels:
      - traefik.enable=true

      # HTTP router for redirecting to HTTPS
      - traefik.http.routers.yochimu-http.rule=Host(`${MY_HOST}`) || Host( `www.${MY_HOST}`)
      - traefik.http.routers.yochimu-http.entrypoints=web
      - traefik.http.routers.yochimu-http.middlewares=redirect-to-https
      - traefik.http.routers.yochimu-http.priority=1

      # HTTPS router serving your app
      - traefik.http.routers.yochimu.rule=Host(`${MY_HOST}`) || Host(`www.${MY_HOST}`)
      - traefik.http.routers.yochimu.entrypoints=websecure
      - traefik.http.routers.yochimu.tls=true
      - traefik.http.routers.yochimu.tls.certresolver=myresolver
      - traefik.http.services.yochimu.loadbalancer.server.port=3000

    networks:
      - web

networks:
  web:
    external: true
